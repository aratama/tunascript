import { log, type Error } from "prelude"
import { map } from "array"
import { createServer, addRoute, listen, responseHtml, type Request, type Response, type JSX } from "http"

// create_tableæ–‡ã§TODOãƒªã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¾ã™
create_table todo {
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  scheduled_at TEXT NOT NULL,
  completed TEXT NOT NULL
}

// ã²ã¨ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’æç”»ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
// create_tableã§å®šç¾©ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€åŒåã®å‹ã¨ã—ã¦ã‚‚å®šç¾©ã•ã‚Œã¾ã™ã€‚
function TodoListItem(props: { row: todo }): JSX {
  const { row } = props
  const { title, scheduled_at, completed } = row
  return <li class="todo-item">
    <label>
      <input type="checkbox" checked={completed == "1"} />
      <span class="todo-title">{title}</span>
      <span class="todo-time">{scheduled_at}</span>
    </label>
  </li>
}

function root(req: Request): Response {

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰TODOãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™
  const fetched = fetch_all {
    SELECT id, title, scheduled_at, completed
    FROM todo
    ORDER BY id
  }

  // swtichå¼ã§ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²ã—ã¾ã™
  return switch (fetched) {

    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
    case e as Error: responseHtml(<p>DB error: {e.message}</p>)

    // æ­£å¸¸ã«å–å¾—ã§ããŸå ´åˆ
    case rows as todo[]: {

      // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™
      responseHtml(
        <html>
          <head>
            <style>{`
              html, body { margin: 0; min-height: 100%; }
              body { display: grid; place-items: center; font-family: 'Fira Sans', 'Noto Sans JP', sans-serif; color: #0b1f33; background: linear-gradient(135deg, #e0f2ff 0%, #fff4d9 50%, #ffdfe3 100%); }
              .card { width: min(92vw, 760px); padding: 32px 36px; border-radius: 18px; background: rgba(255, 255, 255, 0.88); border: 1px solid rgba(255, 255, 255, 0.96); box-shadow: 0 18px 48px rgba(14, 47, 79, 0.18); text-align: left; }
              .badge { display: inline-block; margin-bottom: 10px; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing: 0.08em; color: #fff; background: linear-gradient(90deg, #0ea5e9, #0284c7); }
              h1 { margin: 0 0 6px; font-size: clamp(28px, 5vw, 44px); color: #0f3559; }
              p { margin: 0 0 16px; font-size: clamp(14px, 2.3vw, 18px); color: #355270; }
              .schema { font-family: 'JetBrains Mono', 'UDEV Gothic 35', monospace; font-size: 12px; color: #4b5563; margin-bottom: 12px; }
              ul { margin: 0; padding-left: 0; list-style: none; color: #173754; }
              .todo-item { margin: 10px 0; padding: 10px 12px; border-radius: 10px; background: rgba(255, 255, 255, 0.74); border: 1px solid #dbe7f2; }
              .todo-item label { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
              .todo-item input { width: 16px; height: 16px; accent-color: #0ea5e9; }
              .todo-title { font-weight: 700; color: #0f3559; }
              .todo-time { color: #475569; font-size: 13px; }
            `}</style>
          </head>
          <body>
            <main class="card">
              <span class="badge">SQL TODO DEMO</span>
              <h1>ğŸŸTunaScript TODO ListğŸ£</h1>
              <ul>{map(rows, function (row) { return <TodoListItem row={row} />})}</ul>
            </main>
          </body>
        </html>
      )
    }
  }
}

export function main(): void | Error {

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¦ãŠãã¾ã™
  execute {
    INSERT INTO todo (title, scheduled_at, completed)
    VALUES
      ('è²·ã„ç‰©', '2026-02-05 10:00', '0'),
      ('çŠ¬ã®æ•£æ­©', '2026-02-05 18:30', '1'),
      ('ãƒ©ãƒ³ãƒä¼š', '2026-02-06 12:00', '0')
  }?

  // Playgroundã§ã¯ã€ãƒ«ãƒ¼ãƒˆã®ãƒšãƒ¼ã‚¸ã ã‘å‡ºåŠ›ã•ã‚Œã¾ã™
  const server = createServer()
  server.addRoute("get", "/", root)
  server.listen(":8888")

  // logé–¢æ•°ã§æ¨™æº–å‡ºåŠ›ã§ãã¾ã™
  log("Server is running at http://localhost:8888/")
}
