import { log, stringify, getArgs, length } from "prelude";
import { dbOpen } from "sqlite";

// TODOリスト CLIツール
// 使い方:
//   todo list           - 未完了のタスク一覧を表示
//   todo list --all     - 完了済みも含めてタスク一覧を表示
//   todo open <title>   - タスクを追加
//   todo close <id>     - タスクを完了

// テーブル定義
// dbOpenで自動的にテーブルが作成・検証される
create_table todos {
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  completed INTEGER DEFAULT 0,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
}

function listTodos(): void {
  const todos = fetch_all {
    SELECT id, title, created_at FROM todos WHERE completed = 0 ORDER BY id
  };
  log("ID\tTitle\tCreated");
  log("--\t-----\t-------");
  for (const row of todos) {
    const { id, title, created_at } = row;
    log(id + "\t" + title + "\t" + created_at);
  }
}

function listAllTodos(): void {
  const todos = fetch_all {
    SELECT id, title, completed, created_at FROM todos ORDER BY id
  };
  log("ID\tStatus\tTitle\tCreated");
  log("--\t------\t-----\t-------");
  for (const row of todos) {
    const { id, title, completed, created_at } = row;
    const status = completed == "1" ? "[x]" : "[ ]";
    log(id + "\t" + status + "\t" + title + "\t" + created_at);
  }
}

function openTodo(title: string): void {
  execute {
    INSERT INTO todos (title) VALUES ({title})
  };
  const { id } = fetch_one {
    SELECT last_insert_rowid() AS id
  };
  log("Task #" + id + " created: " + title);
}

function closeTodo(id: string): void {
  execute {
    UPDATE todos SET completed = 1 WHERE id = {id}
  };
  log("Task #" + id + " completed!");
}

function showUsage(): void {
  log("TODOリスト CLIツール");
  log("");
  log("使い方:");
  log("  todo list           - 未完了のタスク一覧を表示");
  log("  todo list --all     - 完了済みも含めてタスク一覧を表示");
  log("  todo open <title>   - タスクを追加");
  log("  todo close <id>     - タスクを完了");
  log("  todo help           - ヘルプを表示");
  log("  todo version        - バージョンを表示");
}

function showVersion(): void {
  log("todo version 1.0.0");
}

export function main(): void {
  const args = getArgs();
  const argc = args.length();

  // データベースを開く（テーブル定義に基づいて自動作成・検証）
  dbOpen("todo.sqlite3");

  if (argc == 0) {
    showUsage();
    return;
  }

  const cmd = args[0];

  // switch式でコマンドを分岐
  switch (cmd) {
    case "list": {
      if (argc >= 2) {
        const opt = args[1];
        if(opt == "--all") {
          listAllTodos();
        } else {
          log("エラー: 不明なオプション: " + opt);
          showUsage();
        }
      } else {
        listTodos();
      }
    }
    case "open": {
      if (argc >= 2) {
        openTodo(args[1]);
      } else {
        log("エラー: タイトルを指定してください");
        showUsage();
      }
    }
    case "close": {
      if (argc >= 2) {
        closeTodo(args[1]);
      } else {
        log("エラー: IDを指定してください");
        showUsage();
      }
    }
    case "help":
      showUsage()
    case "version":
      showVersion()
    default: {
      log("エラー: 不明なコマンド: " + cmd);
      showUsage();
    }
  };

}
