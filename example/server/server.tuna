import { log, getArgs, getEnv } from "prelude"
import { length, map } from "array"
import { createServer, addRoute, listen, responseHtml, responseJson, responseRedirect, type JSX, type Request, type Response } from "http"
import { dbOpen } from "sqlite"
import { Styles } from "./style.tuna"

create_table todos {
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  completed INTEGER DEFAULT 0,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
}

function TodoList(): JSX {
  const fetched = fetch_all {
    SELECT id, title, completed, created_at FROM todos ORDER BY id DESC
  }
  return switch (fetched) {
    case err as error: <p class="empty-message">DB error: {err.message}</p>
    case rows as { id: string, title: string, completed: string, created_at: string }[]:
      if (rows.length() == 0) {
        <p class="empty-message">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
      } else {
        <ul class="todo-list">{rows.map(function (row) {
        const isCompleted = row.completed == "1"
        const itemClass = if (isCompleted) { "todo-item completed" } else { "todo-item" }
        return <li class={itemClass}>
          <form method="POST" action="/toggle" style="display:contents">
            <input type="hidden" name="id" value={row.id} />
            <input type="checkbox" class="todo-checkbox" name="completed" checked={isCompleted} onchange="this.form.submit()" />
          </form>
          <span class="todo-title">{row.title}</span>
          <span class="todo-date">{row.created_at}</span>
        </li>
      })}</ul>
      }
  }
}

function handleRoot(req: Request): Response {
  return responseHtml(
    <html>
      <head>
        <meta charset="utf-8" />
        <title>TODO App - TunaScript</title>
        <Styles />
      </head>
      <body>
        <div class="container">
          <h1>üìù TODO „É™„Çπ„Éà</h1>
          <form class="add-form" method="POST" action="/add">
            <input type="text" name="title" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ..." required="" />
            <button type="submit">ËøΩÂä†</button>
          </form>
          <TodoList />
        </div>
      </body>
    </html>
  )
}

function handleAdd(req: Request): Response {
  const { title } = req.form
  if (title != "") {
    const inserted = execute {
      INSERT INTO todos (title) VALUES ({title})
    }
    const insertError = switch (inserted) {
      case err as error: err.message
      case ok as undefined: ""
    }
    if (insertError != "") {
      return responseHtml(<p>DB error: {insertError}</p>)
    }
  }
  return responseRedirect("/")
}

function handleToggle(req: Request): Response {
  const { id } = req.form
	  const fetched = fetch_one {
	    SELECT completed FROM todos WHERE id = {id}
	  }
	  return switch (fetched) {
	    case err as error: responseHtml(<p>DB error: {err.message}</p>)
	    case row as { completed: string }: {
	      const completed = row.completed
	      const newCompleted = if (completed == "1") { 0 } else { 1 }
	      const updated = execute {
	        UPDATE todos SET completed = {newCompleted} WHERE id = {id}
	      }
	      switch (updated) {
	        case err as error: responseHtml(<p>DB error: {err.message}</p>)
	        case ok as undefined: responseRedirect("/")
	      }
	    }
	  }
}

export function main(): void {
	  // Open or create the database
	  const args = getArgs()
	  const dbPath = if (args.length() > 0) {
    switch (args[0]) {
      case path as string: path
      case e as error: ":memory:"
    }
  } else { ":memory:" }
	  const opened = dbOpen(dbPath)
	  const openError = switch (opened) {
	    case err as error: err.message
	    case ok as undefined: ""
	  }
	  if (openError != "") {
	    log("db open error: " + openError)
	    return
	  }

  // Create server and define routes
  const server = createServer()
  server.addRoute("/", handleRoot)
	  server.addRoute("/add", handleAdd)
	  server.addRoute("/toggle", handleToggle)
	  const portEnv = getEnv("PORT")
	  const port = if (portEnv != "") { portEnv } else { "8888" }
	  log("TODO App starting on http://localhost:" + port)
	  server.listen(":" + port)
	}
